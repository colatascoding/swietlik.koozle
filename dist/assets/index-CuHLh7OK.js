(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function s(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(n){if(n.ep)return;n.ep=!0;const r=s(n);fetch(n.href,r)}})();const B=100,x=50;function k(){return{maxHp:B,hp:B,level:1,xp:0,xpToNext:x}}function A(e,t){let s=e.maxHp,o=1;for(const{def:n,count:r}of t)n.hpBonus&&(s+=n.hpBonus*r),n.xpMod&&(o*=Math.pow(n.xpMod,r));return{...e,maxHp:s,xpToNext:Math.floor(x*Math.pow(1.2,e.level-1)/o)}}function F(e,t,s){let o=e.xp+t,n=e.level,r=Math.floor(x*Math.pow(1.2,n-1));for(;o>=r;)o-=r,n++,r=Math.floor(x*Math.pow(1.2,n-1));const c={...e,xp:o,level:n,xpToNext:r,maxHp:e.maxHp+(n-e.level)*10};return A(c,s)}function $(e){for(const{def:t}of e)if(t.ruleMod)return t.ruleMod}const H=[3],P=[2,3],C=2;function Y(e){if(!e)return{birth:H,survive:P};const t=[],s=[],o=e.toLowerCase().match(/b(\d+)|birth\s*(\d+)/),n=e.toLowerCase().match(/s(\d+)|survive\s*(\d+)/);if(o){const r=o[1]??o[2]??"3";t.push(...r.split("").map(Number))}else t.push(...H);if(n){const r=n[1]??n[2]??"23";s.push(...r.split("").map(Number))}else s.push(...P);return{birth:t,survive:s}}function U(e,t,s){var c;const o=e.length,n=((c=e[0])==null?void 0:c.length)??0;let r=0;for(let d=-1;d<=1;d++)for(let a=-1;a<=1;a++){if(d===0&&a===0)continue;const i=t+d,l=s+a;i<0||i>=o||l<0||l>=n||e[i][l]===1&&(r+=1)}return r}function V(e,t){var d;const{birth:s,survive:o}=Y(t),n=e.length,r=((d=e[0])==null?void 0:d.length)??0,c=e.map(a=>[...a]);for(let a=0;a<n;a++)for(let i=0;i<r;i++){if(e[a][i]===C){c[a][i]=C;continue}const l=U(e,a,i);e[a][i]===1?c[a][i]=o.includes(l)?1:0:c[a][i]=s.includes(l)?1:0}return c}function W(e,t){return Array.from({length:e},()=>Array.from({length:t},()=>0))}function z(e,t,s=.25){const o=W(e,t);for(let n=0;n<e;n++)for(let r=0;r<t;r++){const c=n===0||n===e-1||r===0||r===t-1;o[n][r]=c?C:Math.random()<s?1:0}return o}function q(e,t,s){var n,r;if(((n=e[t])==null?void 0:n[s])===C)return e;const o=e.map(c=>[...c]);return((r=o[t])==null?void 0:r[s])!==void 0&&(o[t][s]=1-o[t][s]),o}function K(e,t){var n,r;const s=e.length,o=((n=e[0])==null?void 0:n.length)??0;if(t.length!==s||(((r=t[0])==null?void 0:r.length)??0)!==o)return!1;for(let c=0;c<s;c++)for(let d=0;d<o;d++)if(e[c][d]!==t[c][d])return!1;return!0}const j=12,J=12,Q=1,Z=3;function ee(e,t){return e+Math.floor(Math.random()*(t-e+1))}function G(e,t){return{id:e,grid:z(j,J),phase:"edit",stepCount:0,ruleMod:t,changesLeft:ee(Q,Z)}}function te(e,t,s){var o;return e.phase!=="edit"||e.changesLeft<1||((o=e.grid[t])==null?void 0:o[s])===C?e:{...e,grid:q(e.grid,t,s),changesLeft:e.changesLeft-1}}function ne(e){return e.phase!=="edit"?e:{...e,phase:"alive",stepCount:0}}function oe(e){if(e.phase!=="alive")return e;const t=V(e.grid,e.ruleMod),s=K(e.grid,t);return{...e,grid:t,stepCount:e.stepCount+1,stable:s}}function re(e){return{...e,phase:"complete"}}function I(e){var t;return{rows:e.grid.length,cols:((t=e.grid[0])==null?void 0:t.length)??0}}const _=[{id:"lens",name:"Lens of Order",description:"Life follows B3/S23 (classic).",ruleMod:"B3/S23"},{id:"chaos_seed",name:"Chaos Seed",description:"Birth on 2 or 3 neighbors — more growth.",ruleMod:"B23/S36"},{id:"heart_amulet",name:"Heart Amulet",description:"+20 max HP.",hpBonus:20},{id:"xp_gem",name:"Scholar Gem",description:"1.25× XP gain.",xpMod:1.25},{id:"still_life",name:"Still Life",description:"Survive on 2,3,4 — more stable patterns.",ruleMod:"B3/S234"}];function se(e){return _.find(t=>t.id===e)}function ie(e){const t=_.filter(s=>!e.includes(s.id));return t[Math.floor(Math.random()*t.length)]??_[0]}function ce(){const e=[],t=$(e);return{phase:"playing",rooms:[G("0",t)],currentRoomIndex:0,character:k(),inventory:e}}function v(e){if(e.rooms.length===0)throw new Error("No rooms in state");return e.rooms[e.currentRoomIndex]??e.rooms[0]}function ae(e){const t=$(e.inventory),s=[...e.rooms,G(String(e.rooms.length),t)];return{...e,rooms:s,currentRoomIndex:s.length-1}}function le(e,t,s=1){if(s<1)return e;const o=se(t);if(!o)return e;const n=[...e.inventory],r=n.findIndex(c=>c.def.id===t);return r>=0?n[r]={...n[r],count:n[r].count+s}:n.push({def:o,count:s}),{...e,inventory:n}}function de(e){const t=e.inventory.map(o=>o.def.id),s=ie(t);return le(e,s.id,1)}function ue(e,t,s){let o={...e,character:F(e.character,t,e.inventory)};return o.character=A(o.character,o.inventory),Math.random()<.4&&(o=de(o)),o}const fe="#7ee8a8",he="#0d0f14",pe="#3d4556",me="#1e232e",ve="rgba(126, 232, 168, 0.15)";function ge(e,t,s,o,n,r){var a;const c=t.length,d=((a=t[0])==null?void 0:a.length)??0;e.fillStyle=he,e.fillRect(0,0,d*o,c*n);for(let i=0;i<c;i++)for(let l=0;l<d;l++){const h=l*o,m=i*n,M=t[i][l];M===C?(e.fillStyle=pe,e.fillRect(h,m,o,n)):M===1&&(e.fillStyle=fe,e.fillRect(h+.5,m+.5,o-1,n-1))}if(r){e.strokeStyle=me,e.lineWidth=1;for(let i=0;i<=c;i++)e.beginPath(),e.moveTo(0,i*n),e.lineTo(d*o,i*n),e.stroke();for(let i=0;i<=d;i++)e.beginPath(),e.moveTo(i*o,0),e.lineTo(i*o,c*n),e.stroke()}s==="edit"&&(e.fillStyle=ve,e.fillRect(0,0,d*o,c*n))}function Ce(e,t,s,o=20){const n=e.width,r=e.height,c=Math.max(1,s),d=Math.max(1,t),a=Math.max(1,Math.min(o,Math.floor(n/c),Math.floor(r/d))),i=a,l=s*a,h=t*i;return{cellW:a,cellH:i,offsetX:(n-l)/2,offsetY:(r-h)/2}}function Le(e,t,s,o,n,r,c,d,a){if(s<=0||o<=0)return null;const i=a.getBoundingClientRect();if(!i.width||!i.height)return null;const l=a.width/i.width,h=a.height/i.height,m=(c-i.left)*l-e,M=(d-i.top)*h-t,N=Math.floor(m/s),T=Math.floor(M/o);return T>=0&&T<n&&N>=0&&N<r?{row:T,col:N}:null}let u=ce(),p={cellW:12,cellH:12,offsetX:0,offsetY:0},b=null;const ye=120,Ee=document.getElementById("app"),f=document.createElement("canvas");f.id="roomCanvas";const w=document.createElement("header");w.className="header";const g=document.createElement("aside");g.className="sidebar";function X(){w.innerHTML="";const e=document.createElement("h1");e.textContent="Świetlik Koozle";const t=document.createElement("span");t.className="muted",t.textContent=`Room ${u.currentRoomIndex+1} / ${u.rooms.length}`,t.style.color="var(--muted)",w.append(e,t)}function R(){const e=v(u);I(e),g.innerHTML="";const t=document.createElement("div");t.className="panel";const s=document.createElement("div");s.className=`room-status ${e.phase}${e.stable?" stable":""}`,s.textContent=e.phase==="edit"?`Changes left: ${e.changesLeft}. Toggle cells, then start life.`:e.phase==="alive"?e.stable?`Life stable — no change (step ${e.stepCount}). Finish to collect reward.`:`Life running — step ${e.stepCount}`:"Room complete — go to next",t.appendChild(s);const o=document.createElement("div");o.style.marginTop="0.75rem";const n=document.createElement("button");n.className="btn btn-block",n.textContent=e.phase==="edit"?"Start life":e.phase==="alive"?"Running…":"Next room",n.disabled=e.phase==="alive",n.onclick=()=>{const l=v(u);l.phase==="edit"?(y(ne(l)),Me()):l.phase==="complete"&&(u=ue(u,15+l.stepCount),u=ae(u),y(v(u)),S(),X(),R(),L())};const r=document.createElement("button");r.className="btn btn-block",r.textContent="Finish room & get reward",r.style.marginTop="0.5rem",r.disabled=e.phase!=="alive",r.onclick=()=>{const l=v(u);l.phase==="alive"&&(S(),y(re(l)),R(),L())},o.append(n,r),t.append(o),g.appendChild(t);const c=document.createElement("div");c.className="panel";const d=A(u.character,u.inventory);c.innerHTML=`
    <h3>Character</h3>
    <div class="stat-row"><span>Level</span><span>${d.level}</span></div>
    <div class="stat-row"><span>XP</span><span>${d.xp} / ${d.xpToNext}</span></div>
    <div class="stat-row"><span>HP</span><span>${u.character.hp} / ${d.maxHp}</span></div>
    <div class="health-bar"><div class="health-fill" style="width: ${d.maxHp>0?100*u.character.hp/d.maxHp:0}%"></div></div>
  `,g.appendChild(c);const a=document.createElement("div");a.className="panel",a.innerHTML="<h3>Inventory</h3>";const i=document.createElement("ul");if(i.className="inventory-list",u.inventory.length===0){const l=document.createElement("li");l.textContent="No items yet. Complete rooms for rewards.",l.style.color="var(--muted)",i.appendChild(l)}else for(const{def:l,count:h}of u.inventory){const m=document.createElement("li");m.textContent=`${l.name}${h>1?` ×${h}`:""}`,m.title=l.description,i.appendChild(m)}a.appendChild(i),g.appendChild(a)}function y(e){const t=[...u.rooms];t[u.currentRoomIndex]=e,u={...u,rooms:t}}function Me(){S(),b=window.setInterval(()=>{const e=v(u);if(e.phase!=="alive")return;const t=oe(e);y(t),R(),L(),t.stable&&S()},ye)}function S(){b!=null&&(clearInterval(b),b=null)}function L(){const e=v(u);I(e);const t=f.getContext("2d");t.save(),t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,f.width,f.height),t.restore(),t.save(),t.translate(p.offsetX,p.offsetY),ge(t,e.grid,e.phase,p.cellW,p.cellH,e.phase==="edit"||p.cellW>=14),t.restore()}function D(){const t=f.parentElement.getBoundingClientRect(),s=v(u),{rows:o,cols:n}=I(s);f.width=t.width,f.height=t.height,p=Ce(f,o,n,22),L()}function be(e){const t=v(u);if(t.phase!=="edit"||t.changesLeft<1)return;const{rows:s,cols:o}=I(t),n=Le(p.offsetX,p.offsetY,p.cellW,p.cellH,s,o,e.clientX,e.clientY,f);n&&(y(te(t,n.row,n.col)),L())}const E=document.createElement("div");E.className="game-layout";const O=document.createElement("div");O.className="room-canvas-wrap";O.appendChild(f);E.appendChild(w);E.appendChild(O);E.appendChild(g);Ee.appendChild(E);X();R();D();L();f.addEventListener("click",be);window.addEventListener("resize",D);
