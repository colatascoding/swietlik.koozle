(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function r(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(n){if(n.ep)return;n.ep=!0;const o=r(n);fetch(n.href,o)}})();const X=100,N=50;function q(){return{maxHp:X,hp:X,level:1,xp:0,xpToNext:N}}function A(e,t){let r=e.maxHp,a=1;for(const{def:n,count:o}of t)n.hpBonus&&(r+=n.hpBonus*o),n.xpMod&&(a*=Math.pow(n.xpMod,o));return{...e,maxHp:r,xpToNext:Math.floor(N*Math.pow(1.2,e.level-1)/a)}}function K(e,t,r){let a=e.xp+t,n=e.level,o=Math.floor(N*Math.pow(1.2,n-1));for(;a>=o;)a-=o,n++,o=Math.floor(N*Math.pow(1.2,n-1));const i={...e,xp:a,level:n,xpToNext:o,maxHp:e.maxHp+(n-e.level)*10};return A(i,r)}function j(e,t){return{...e,hp:Math.max(0,e.hp-t)}}function Y(e){for(const{def:t}of e)if(t.ruleMod)return t.ruleMod}const D=[3],k=[2,3],y=2;function F(e){if(!e)return{birth:D,survive:k};const t=[],r=[],a=e.toLowerCase().match(/b(\d+)|birth\s*(\d+)/),n=e.toLowerCase().match(/s(\d+)|survive\s*(\d+)/);if(a){const o=a[1]??a[2]??"3";t.push(...o.split("").map(Number))}else t.push(...D);if(n){const o=n[1]??n[2]??"23";r.push(...o.split("").map(Number))}else r.push(...k);return{birth:t,survive:r}}function J(e,t,r){var i;const a=e.length,n=((i=e[0])==null?void 0:i.length)??0;let o=0;for(let l=-1;l<=1;l++)for(let d=-1;d<=1;d++){if(l===0&&d===0)continue;const c=t+l,m=r+d;c<0||c>=a||m<0||m>=n||e[c][m]===1&&(o+=1)}return o}function Q(e,t,r,a){var l,d;const n=t.length,o=((l=t[0])==null?void 0:l.length)??0,i=[];for(let c=-1;c<=1;c++)for(let m=-1;m<=1;m++){if(c===0&&m===0)continue;const p=r+c,u=a+m;if(!(p<0||p>=n||u<0||u>=o)&&t[p][u]===1){const s=((d=e[p])==null?void 0:d[u])??-1;s>=0&&i.push(s)}}return i}function Z(e,t,r,a){var c,m,p;const n=e.length,o=((c=e[0])==null?void 0:c.length)??0,i=e.map(u=>[...u]),l=t.map(u=>[...u]),d=F(a);for(let u=0;u<n;u++)for(let s=0;s<o;s++){if(e[u][s]===y){i[u][s]=y,l[u][s]=-1;continue}const f=J(e,u,s),g=e[u][s]===1,w=((m=t[u])==null?void 0:m[s])??-1,M=w>=0?F((p=r[w])==null?void 0:p.ruleMod):d;if(g){const v=M.survive.includes(f);i[u][s]=v?1:0,l[u][s]=v?w:-1}else{const v=d.birth.includes(f);if(i[u][s]=v?1:0,v){const O=Q(t,e,u,s);l[u][s]=O.length>0?O[Math.floor(Math.random()*O.length)]:-1,l[u][s]<0&&(l[u][s]=0)}else l[u][s]=-1}}return{grid:i,mobGrid:l}}function ee(e,t){return Array.from({length:e},()=>Array.from({length:t},()=>0))}function te(e,t,r=.25){const a=ee(e,t);for(let n=0;n<e;n++)for(let o=0;o<t;o++){const i=n===0||n===e-1||o===0||o===t-1;a[n][o]=i?y:Math.random()<r?1:0}return a}function ne(e,t,r){var n,o;if(((n=e[t])==null?void 0:n[r])===y)return e;const a=e.map(i=>[...i]);return((o=a[t])==null?void 0:o[r])!==void 0&&(a[t][r]=1-a[t][r]),a}function oe(e,t){var n,o;const r=e.length,a=((n=e[0])==null?void 0:n.length)??0;if(t.length!==r||(((o=t[0])==null?void 0:o.length)??0)!==a)return!1;for(let i=0;i<r;i++)for(let l=0;l<a;l++)if(e[i][l]!==t[i][l])return!1;return!0}const P=[{id:"slime",name:"Slime",color:"#7ee8a8",damage:2,xpReward:5,ruleMod:"B3/S23",behavior:"Born when exactly 3 neighbors. Survives with 2 or 3; else dies of loneliness or overcrowding."},{id:"phantom",name:"Phantom",color:"#8ea4e8",damage:4,xpReward:10,ruleMod:"B2/S",behavior:"Appears with only 2 neighbors. Survives with 2; very fragile and spreads in sparse areas."},{id:"blob",name:"Blob",color:"#c87ee8",damage:3,xpReward:7,ruleMod:"B34/S34",behavior:"Born with 3 or 4 neighbors. Survives with 3 or 4. Loves crowded spots; forms dense clusters."},{id:"spore",name:"Spore",color:"#e8d87e",damage:1,xpReward:4,ruleMod:"B36/S23",behavior:"Spawns with 3 or 6 neighbors. Survives with 2 or 3. Can pop up in busy or hexagonal patterns."},{id:"glider",name:"Glider",color:"#7ee8e8",damage:3,xpReward:8,ruleMod:"B3/S23",behavior:"Classic rules: birth on 3, survive on 2 or 3. Can form shapes that drift across the grid."},{id:"pulsar",name:"Pulsar",color:"#e89a7e",damage:6,xpReward:15,ruleMod:"B3/S234",behavior:"Born with 3 neighbors. Survives with 2, 3, or 4. More tolerant—often forms stable, oscillating patterns."},{id:"shifter",name:"Shifter",color:"#e87ec8",damage:5,xpReward:12,ruleMod:"B23/S36",behavior:"Born with 2 or 3 neighbors. Survives with 3, 4, 5, or 6. Grows fast and thrives in dense neighborhoods."},{id:"eater",name:"Eater",color:"#5a9a6e",damage:5,xpReward:11,ruleMod:"B3/S23",behavior:"Standard rules. Often part of structures that absorb or block other patterns."},{id:"loaf",name:"Loaf",color:"#a88a5a",damage:2,xpReward:6,ruleMod:"B3/S23",behavior:"Classic birth/survive. Forms compact still lifes that don’t change."},{id:"beehive",name:"Beehive",color:"#e8c87e",damage:4,xpReward:9,ruleMod:"B3/S234",behavior:"Birth on 3, survives with 2–4 neighbors. Tends to settle into stable hexagonal blobs."},{id:"toad",name:"Toad",color:"#7eb8e8",damage:4,xpReward:10,ruleMod:"B3/S23",behavior:"Classic rules. Often appears in oscillating patterns that flip every step."},{id:"pentomino",name:"Pentomino",color:"#e87e7e",damage:7,xpReward:18,ruleMod:"B3/S23",behavior:"Standard birth/survive. Small seed that can explode into long-lived, chaotic growth."}],re=6;function U(){return Math.floor(Math.random()*re)}function ae(e,t,r){var i,l;const a=e.length,n=((i=e[0])==null?void 0:i.length)??0,o=[];for(let d=0;d<a;d++)for(let c=0;c<n;c++){if(e[d][c]!==1)continue;const m=((l=t[d])==null?void 0:l[c])??0,p=r[m];p&&o.push(p)}return o}const se=12,ie=12,le=1,ce=3;function de(e,t){return e+Math.floor(Math.random()*(t-e+1))}function ue(e){var n;const t=e.length,r=((n=e[0])==null?void 0:n.length)??0,a=Array.from({length:t},()=>Array(r).fill(-1));for(let o=0;o<t;o++)for(let i=0;i<r;i++)e[o][i]===1&&(a[o][i]=U());return a}function W(e,t){const r=te(se,ie);return{id:e,grid:r,mobGrid:ue(r),phase:"edit",stepCount:0,ruleMod:t,changesLeft:de(le,ce)}}function he(e,t,r){var o;if(e.phase!=="edit"||e.changesLeft<1||((o=e.grid[t])==null?void 0:o[r])===y)return e;const a=ne(e.grid,t,r),n=e.mobGrid.map(i=>[...i]);return a[t][r]===1?n[t][r]=U():n[t][r]=-1,{...e,grid:a,mobGrid:n,changesLeft:e.changesLeft-1}}function me(e){return e.phase!=="edit"?e:{...e,phase:"alive",stepCount:0}}function pe(e){if(e.phase!=="alive")return e;const{grid:t,mobGrid:r}=Z(e.grid,e.mobGrid,P,e.ruleMod),a=oe(e.grid,t);return{...e,grid:t,mobGrid:r,stepCount:e.stepCount+1,stable:a}}function fe(e){return{...e,phase:"complete"}}function _(e){var t;return{rows:e.grid.length,cols:((t=e.grid[0])==null?void 0:t.length)??0}}const $=[{id:"lens",name:"Lens of Order",description:"Life follows B3/S23 (classic).",ruleMod:"B3/S23"},{id:"chaos_seed",name:"Chaos Seed",description:"Birth on 2 or 3 neighbors — more growth.",ruleMod:"B23/S36"},{id:"heart_amulet",name:"Heart Amulet",description:"+20 max HP.",hpBonus:20},{id:"xp_gem",name:"Scholar Gem",description:"1.25× XP gain.",xpMod:1.25},{id:"still_life",name:"Still Life",description:"Survive on 2,3,4 — more stable patterns.",ruleMod:"B3/S234"}];function ge(e){return $.find(t=>t.id===e)}function ve(e){const t=$.filter(r=>!e.includes(r.id));return t[Math.floor(Math.random()*t.length)]??$[0]}function be(){const e=[],t=Y(e);return{phase:"playing",rooms:[W("0",t)],currentRoomIndex:0,character:q(),inventory:e}}function E(e){if(e.rooms.length===0)throw new Error("No rooms in state");return e.rooms[e.currentRoomIndex]??e.rooms[0]}function we(e){const t=Y(e.inventory),r=[...e.rooms,W(String(e.rooms.length),t)];return{...e,rooms:r,currentRoomIndex:r.length-1}}function xe(e,t,r=1){if(r<1)return e;const a=ge(t);if(!a)return e;const n=[...e.inventory],o=n.findIndex(i=>i.def.id===t);return o>=0?n[o]={...n[o],count:n[o].count+r}:n.push({def:a,count:r}),{...e,inventory:n}}function Me(e){const t=e.inventory.map(a=>a.def.id),r=ve(t);return xe(e,r.id,1)}function Ce(e,t,r,a){const n=ae(a.grid,a.mobGrid,P),o=n.reduce((d,c)=>d+c.damage,0),i=n.reduce((d,c)=>d+c.xpReward,0);let l={...e,character:j(e.character,o),lastEncounter:{mobs:n,damage:o,xp:i}};return l.phase=l.character.hp<=0?"dead":e.phase,l.character=K(l.character,t+i,l.inventory),l.character=A(l.character,l.inventory),Math.random()<.4&&(l=Me(l)),l}const Ee="#0d0f14",ye="#3d4556",Se="#1e232e",Le="rgba(126, 232, 168, 0.15)";function Re(e,t,r,a,n,o,i,l){var m,p,u;const d=t.length,c=((m=t[0])==null?void 0:m.length)??0;e.fillStyle=Ee,e.fillRect(0,0,c*o,d*i);for(let s=0;s<d;s++)for(let f=0;f<c;f++){const g=f*o,w=s*i,M=t[s][f];if(M===y)e.fillStyle=ye,e.fillRect(g,w,o,i);else if(M===1){const v=((p=r[s])==null?void 0:p[f])??0;e.fillStyle=((u=a[v])==null?void 0:u.color)??"#7ee8a8",e.fillRect(g+.5,w+.5,o-1,i-1)}}if(l){e.strokeStyle=Se,e.lineWidth=1;for(let s=0;s<=d;s++)e.beginPath(),e.moveTo(0,s*i),e.lineTo(c*o,s*i),e.stroke();for(let s=0;s<=c;s++)e.beginPath(),e.moveTo(s*o,0),e.lineTo(s*o,d*i),e.stroke()}n==="edit"&&(e.fillStyle=Le,e.fillRect(0,0,c*o,d*i))}function Be(e,t,r,a=20){const n=e.width,o=e.height,i=Math.max(1,r),l=Math.max(1,t),d=Math.max(1,Math.min(a,Math.floor(n/i),Math.floor(o/l))),c=d,m=r*d,p=t*c;return{cellW:d,cellH:c,offsetX:(n-m)/2,offsetY:(o-p)/2}}function Ne(e,t,r,a,n,o,i,l,d){if(r<=0||a<=0)return null;const c=d.getBoundingClientRect();if(!c.width||!c.height)return null;const m=d.width/c.width,p=d.height/c.height,u=(i-c.left)*m-e,s=(l-c.top)*p-t,f=Math.floor(u/r),g=Math.floor(s/a);return g>=0&&g<n&&f>=0&&f<o?{row:g,col:f}:null}let h=be(),x={cellW:12,cellH:12,offsetX:0,offsetY:0},B=null;const Te=120,Ie=document.getElementById("app"),b=document.createElement("canvas");b.id="roomCanvas";const T=document.createElement("header");T.className="header";const C=document.createElement("aside");C.className="sidebar";function z(){T.innerHTML="";const e=document.createElement("h1");e.textContent="Świetlik Koozle";const t=document.createElement("span");t.className="muted",t.textContent=`Room ${h.currentRoomIndex+1} / ${h.rooms.length}`,t.style.color="var(--muted)",T.append(e,t)}function I(){const e=E(h);_(e),C.innerHTML="";const t=document.createElement("div");t.className="panel";const r=document.createElement("div");r.className=`room-status ${e.phase}${e.stable?" stable":""}`,r.textContent=e.phase==="edit"?`Changes left: ${e.changesLeft}. Toggle cells, then start life.`:e.phase==="alive"?e.stable?`Life stable — no change (step ${e.stepCount}). Finish to collect reward.`:`Life running — step ${e.stepCount}`:"Room complete — go to next",t.appendChild(r);const a=document.createElement("div");a.style.marginTop="0.75rem";const n=document.createElement("button");n.className="btn btn-block",n.textContent=e.phase==="edit"?"Start life":e.phase==="alive"?"Running…":"Next room",n.disabled=e.phase==="alive",n.onclick=()=>{const s=E(h);s.phase==="edit"?(L(me(s)),Ge()):s.phase==="complete"&&(h=Ce(h,15+s.stepCount,!0,s),h=we(h),L(E(h)),G(),z(),I(),S())};const o=document.createElement("button");if(o.className="btn btn-block",o.textContent="Finish room & get reward",o.style.marginTop="0.5rem",o.disabled=e.phase!=="alive",o.onclick=()=>{const s=E(h);s.phase==="alive"&&(G(),L(fe(s)),I(),S())},a.append(n,o),t.append(a),C.appendChild(t),h.lastEncounter&&h.lastEncounter.mobs.length>0){const s=document.createElement("div");s.className="panel encounter-panel";const f=h.lastEncounter.mobs.map(g=>g.name).join(", ");s.innerHTML=`
      <h3>Last encounter</h3>
      <p class="encounter-text">Defeated: ${f}</p>
      <p class="encounter-text">+${h.lastEncounter.xp} XP · Took ${h.lastEncounter.damage} damage</p>
    `,C.appendChild(s)}const i=document.createElement("div");i.className="panel";const l=A(h.character,h.inventory);i.innerHTML=`
    <h3>Character</h3>
    <div class="stat-row"><span>Level</span><span>${l.level}</span></div>
    <div class="stat-row"><span>XP</span><span>${l.xp} / ${l.xpToNext}</span></div>
    <div class="stat-row"><span>HP</span><span>${h.character.hp} / ${l.maxHp}</span></div>
    <div class="health-bar"><div class="health-fill" style="width: ${l.maxHp>0?100*h.character.hp/l.maxHp:0}%"></div></div>
  `,C.appendChild(i);const d=document.createElement("div");d.className="panel",d.innerHTML="<h3>Inventory</h3>";const c=document.createElement("ul");if(c.className="inventory-list",h.inventory.length===0){const s=document.createElement("li");s.textContent="No items yet. Complete rooms for rewards.",s.style.color="var(--muted)",c.appendChild(s)}else for(const{def:s,count:f}of h.inventory){const g=document.createElement("li");g.textContent=`${s.name}${f>1?` ×${f}`:""}`,g.title=s.description,c.appendChild(g)}d.appendChild(c),C.appendChild(d);const m=document.createElement("div");m.className="panel legend-panel";const p=document.createElement("h3");p.textContent="Mob legend",p.title="Creatures you may meet in the grid",m.appendChild(p);const u=document.createElement("ul");u.className="legend-list";for(const s of P){const f=document.createElement("li");f.className="legend-entry";const g=document.createElement("span");g.className="legend-swatch",g.style.backgroundColor=s.color;const w=document.createElement("div");w.className="legend-content";const M=document.createElement("span");M.className="legend-label",M.textContent=`${s.name} (${s.damage} dmg · ${s.xpReward} XP)`;const v=document.createElement("p");v.className="legend-behavior",v.textContent=s.behavior,w.append(M,v),f.append(g,w),u.appendChild(f)}m.appendChild(u),C.appendChild(m)}function L(e){const t=[...h.rooms];t[h.currentRoomIndex]=e,h={...h,rooms:t}}function Ge(){G(),B=window.setInterval(()=>{const e=E(h);if(e.phase!=="alive")return;const t=pe(e);L(t),I(),S(),t.stable&&G()},Te)}function G(){B!=null&&(clearInterval(B),B=null)}function S(){const e=E(h);_(e);const t=b.getContext("2d");t.save(),t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,b.width,b.height),t.restore(),t.save(),t.translate(x.offsetX,x.offsetY),Re(t,e.grid,e.mobGrid,P,e.phase,x.cellW,x.cellH,e.phase==="edit"||x.cellW>=14),t.restore()}function V(){const t=b.parentElement.getBoundingClientRect(),r=E(h),{rows:a,cols:n}=_(r);b.width=t.width,b.height=t.height,x=Be(b,a,n,22),S()}function Pe(e){const t=E(h);if(t.phase!=="edit"||t.changesLeft<1)return;const{rows:r,cols:a}=_(t),n=Ne(x.offsetX,x.offsetY,x.cellW,x.cellH,r,a,e.clientX,e.clientY,b);n&&(L(he(t,n.row,n.col)),S())}const R=document.createElement("div");R.className="game-layout";const H=document.createElement("div");H.className="room-canvas-wrap";H.appendChild(b);R.appendChild(T);R.appendChild(H);R.appendChild(C);Ie.appendChild(R);z();I();V();S();b.addEventListener("click",Pe);window.addEventListener("resize",V);
