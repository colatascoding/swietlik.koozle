(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function s(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(n){if(n.ep)return;n.ep=!0;const r=s(n);fetch(n.href,r)}})();const H=100,M=50;function D(){return{maxHp:H,hp:H,level:1,xp:0,xpToNext:M}}function T(e,t){let s=e.maxHp,o=1;for(const{def:n,count:r}of t)n.hpBonus&&(s+=n.hpBonus*r),n.xpMod&&(o*=Math.pow(n.xpMod,r));return{...e,maxHp:s,xpToNext:Math.floor(M*Math.pow(1.2,e.level-1)/o)}}function k(e,t,s){let o=e.xp+t,n=e.level,r=Math.floor(M*Math.pow(1.2,n-1));for(;o>=r;)o-=r,n++,r=Math.floor(M*Math.pow(1.2,n-1));const c={...e,xp:o,level:n,xpToNext:r,maxHp:e.maxHp+(n-e.level)*10};return T(c,s)}function O(e){for(const{def:t}of e)if(t.ruleMod)return t.ruleMod}const A=[3],B=[2,3];function F(e){if(!e)return{birth:A,survive:B};const t=[],s=[],o=e.toLowerCase().match(/b(\d+)|birth\s*(\d+)/),n=e.toLowerCase().match(/s(\d+)|survive\s*(\d+)/);if(o){const r=o[1]??o[2]??"3";t.push(...r.split("").map(Number))}else t.push(...A);if(n){const r=n[1]??n[2]??"23";s.push(...r.split("").map(Number))}else s.push(...B);return{birth:t,survive:s}}function Y(e,t,s){var c;const o=e.length,n=((c=e[0])==null?void 0:c.length)??0;let r=0;for(let a=-1;a<=1;a++)for(let l=-1;l<=1;l++){if(a===0&&l===0)continue;const i=(t+a+o)%o,d=(s+l+n)%n;r+=e[i][d]}return r}function U(e,t){var a;const{birth:s,survive:o}=F(t),n=e.length,r=((a=e[0])==null?void 0:a.length)??0,c=e.map(l=>[...l]);for(let l=0;l<n;l++)for(let i=0;i<r;i++){const d=Y(e,l,i);e[l][i]===1?c[l][i]=o.includes(d)?1:0:c[l][i]=s.includes(d)?1:0}return c}function V(e,t){return Array.from({length:e},()=>Array.from({length:t},()=>0))}function z(e,t,s=.25){const o=V(e,t);for(let n=0;n<e;n++)for(let r=0;r<t;r++)o[n][r]=Math.random()<s?1:0;return o}function W(e,t,s){var n;const o=e.map(r=>[...r]);return((n=o[t])==null?void 0:n[s])!==void 0&&(o[t][s]=1-o[t][s]),o}function q(e,t){var n,r;const s=e.length,o=((n=e[0])==null?void 0:n.length)??0;if(t.length!==s||(((r=t[0])==null?void 0:r.length)??0)!==o)return!1;for(let c=0;c<s;c++)for(let a=0;a<o;a++)if(e[c][a]!==t[c][a])return!1;return!0}const K=12,j=12,J=1,Q=3;function Z(e,t){return e+Math.floor(Math.random()*(t-e+1))}function P(e,t){return{id:e,grid:z(K,j),phase:"edit",stepCount:0,ruleMod:t,changesLeft:Z(J,Q)}}function ee(e,t,s){return e.phase!=="edit"||e.changesLeft<1?e:{...e,grid:W(e.grid,t,s),changesLeft:e.changesLeft-1}}function te(e){return e.phase!=="edit"?e:{...e,phase:"alive",stepCount:0}}function ne(e){if(e.phase!=="alive")return e;const t=U(e.grid,e.ruleMod),s=q(e.grid,t);return{...e,grid:t,stepCount:e.stepCount+1,stable:s}}function oe(e){return{...e,phase:"complete"}}function R(e){var t;return{rows:e.grid.length,cols:((t=e.grid[0])==null?void 0:t.length)??0}}const S=[{id:"lens",name:"Lens of Order",description:"Life follows B3/S23 (classic).",ruleMod:"B3/S23"},{id:"chaos_seed",name:"Chaos Seed",description:"Birth on 2 or 3 neighbors — more growth.",ruleMod:"B23/S36"},{id:"heart_amulet",name:"Heart Amulet",description:"+20 max HP.",hpBonus:20},{id:"xp_gem",name:"Scholar Gem",description:"1.25× XP gain.",xpMod:1.25},{id:"still_life",name:"Still Life",description:"Survive on 2,3,4 — more stable patterns.",ruleMod:"B3/S234"}];function re(e){return S.find(t=>t.id===e)}function se(e){const t=S.filter(s=>!e.includes(s.id));return t[Math.floor(Math.random()*t.length)]??S[0]}function ie(){const e=[],t=O(e);return{phase:"playing",rooms:[P("0",t)],currentRoomIndex:0,character:D(),inventory:e}}function m(e){if(e.rooms.length===0)throw new Error("No rooms in state");return e.rooms[e.currentRoomIndex]??e.rooms[0]}function ce(e){const t=O(e.inventory),s=[...e.rooms,P(String(e.rooms.length),t)];return{...e,rooms:s,currentRoomIndex:s.length-1}}function ae(e,t,s=1){if(s<1)return e;const o=re(t);if(!o)return e;const n=[...e.inventory],r=n.findIndex(c=>c.def.id===t);return r>=0?n[r]={...n[r],count:n[r].count+s}:n.push({def:o,count:s}),{...e,inventory:n}}function le(e){const t=e.inventory.map(o=>o.def.id),s=se(t);return ae(e,s.id,1)}function de(e,t,s){let o={...e,character:k(e.character,t,e.inventory)};return o.character=T(o.character,o.inventory),Math.random()<.4&&(o=le(o)),o}const ue="#7ee8a8",fe="#0d0f14",he="#1e232e",pe="rgba(126, 232, 168, 0.15)";function me(e,t,s,o,n,r){var l;const c=t.length,a=((l=t[0])==null?void 0:l.length)??0;e.fillStyle=fe,e.fillRect(0,0,a*o,c*n);for(let i=0;i<c;i++)for(let d=0;d<a;d++){const p=d*o,g=i*n;t[i][d]===1&&(e.fillStyle=ue,e.fillRect(p+.5,g+.5,o-1,n-1))}if(r){e.strokeStyle=he,e.lineWidth=1;for(let i=0;i<=c;i++)e.beginPath(),e.moveTo(0,i*n),e.lineTo(a*o,i*n),e.stroke();for(let i=0;i<=a;i++)e.beginPath(),e.moveTo(i*o,0),e.lineTo(i*o,c*n),e.stroke()}s==="edit"&&(e.fillStyle=pe,e.fillRect(0,0,a*o,c*n))}function ge(e,t,s,o=20){const n=e.width,r=e.height,c=Math.max(1,s),a=Math.max(1,t),l=Math.max(1,Math.min(o,Math.floor(n/c),Math.floor(r/a))),i=l,d=s*l,p=t*i;return{cellW:l,cellH:i,offsetX:(n-d)/2,offsetY:(r-p)/2}}function ve(e,t,s,o,n,r,c,a,l){if(s<=0||o<=0)return null;const i=l.getBoundingClientRect();if(!i.width||!i.height)return null;const d=l.width/i.width,p=l.height/i.height,g=(c-i.left)*d-e,X=(a-i.top)*p-t,I=Math.floor(g/s),N=Math.floor(X/o);return N>=0&&N<n&&I>=0&&I<r?{row:N,col:I}:null}let u=ie(),h={cellW:12,cellH:12,offsetX:0,offsetY:0},E=null;const Ce=120,Le=document.getElementById("app"),f=document.createElement("canvas");f.id="roomCanvas";const w=document.createElement("header");w.className="header";const v=document.createElement("aside");v.className="sidebar";function $(){w.innerHTML="";const e=document.createElement("h1");e.textContent="Świetlik Koozle";const t=document.createElement("span");t.className="muted",t.textContent=`Room ${u.currentRoomIndex+1} / ${u.rooms.length}`,t.style.color="var(--muted)",w.append(e,t)}function x(){const e=m(u);R(e),v.innerHTML="";const t=document.createElement("div");t.className="panel";const s=document.createElement("div");s.className=`room-status ${e.phase}${e.stable?" stable":""}`,s.textContent=e.phase==="edit"?`Changes left: ${e.changesLeft}. Toggle cells, then start life.`:e.phase==="alive"?e.stable?`Life stable — no change (step ${e.stepCount}). Finish to collect reward.`:`Life running — step ${e.stepCount}`:"Room complete — go to next",t.appendChild(s);const o=document.createElement("div");o.style.marginTop="0.75rem";const n=document.createElement("button");n.className="btn btn-block",n.textContent=e.phase==="edit"?"Start life":e.phase==="alive"?"Running…":"Next room",n.disabled=e.phase==="alive",n.onclick=()=>{const d=m(u);d.phase==="edit"?(L(te(d)),ye()):d.phase==="complete"&&(u=de(u,15+d.stepCount),u=ce(u),L(m(u)),b(),$(),x(),C())};const r=document.createElement("button");r.className="btn btn-block",r.textContent="Finish room & get reward",r.style.marginTop="0.5rem",r.disabled=e.phase!=="alive",r.onclick=()=>{const d=m(u);d.phase==="alive"&&(b(),L(oe(d)),x(),C())},o.append(n,r),t.append(o),v.appendChild(t);const c=document.createElement("div");c.className="panel";const a=T(u.character,u.inventory);c.innerHTML=`
    <h3>Character</h3>
    <div class="stat-row"><span>Level</span><span>${a.level}</span></div>
    <div class="stat-row"><span>XP</span><span>${a.xp} / ${a.xpToNext}</span></div>
    <div class="stat-row"><span>HP</span><span>${u.character.hp} / ${a.maxHp}</span></div>
    <div class="health-bar"><div class="health-fill" style="width: ${a.maxHp>0?100*u.character.hp/a.maxHp:0}%"></div></div>
  `,v.appendChild(c);const l=document.createElement("div");l.className="panel",l.innerHTML="<h3>Inventory</h3>";const i=document.createElement("ul");if(i.className="inventory-list",u.inventory.length===0){const d=document.createElement("li");d.textContent="No items yet. Complete rooms for rewards.",d.style.color="var(--muted)",i.appendChild(d)}else for(const{def:d,count:p}of u.inventory){const g=document.createElement("li");g.textContent=`${d.name}${p>1?` ×${p}`:""}`,g.title=d.description,i.appendChild(g)}l.appendChild(i),v.appendChild(l)}function L(e){const t=[...u.rooms];t[u.currentRoomIndex]=e,u={...u,rooms:t}}function ye(){b(),E=window.setInterval(()=>{const e=m(u);if(e.phase!=="alive")return;const t=ne(e);L(t),x(),C(),t.stable&&b()},Ce)}function b(){E!=null&&(clearInterval(E),E=null)}function C(){const e=m(u);R(e);const t=f.getContext("2d");t.save(),t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,f.width,f.height),t.restore(),t.save(),t.translate(h.offsetX,h.offsetY),me(t,e.grid,e.phase,h.cellW,h.cellH,e.phase==="edit"||h.cellW>=14),t.restore()}function G(){const t=f.parentElement.getBoundingClientRect(),s=m(u),{rows:o,cols:n}=R(s);f.width=t.width,f.height=t.height,h=ge(f,o,n,22),C()}function Ee(e){const t=m(u);if(t.phase!=="edit"||t.changesLeft<1)return;const{rows:s,cols:o}=R(t),n=ve(h.offsetX,h.offsetY,h.cellW,h.cellH,s,o,e.clientX,e.clientY,f);n&&(L(ee(t,n.row,n.col)),C())}const y=document.createElement("div");y.className="game-layout";const _=document.createElement("div");_.className="room-canvas-wrap";_.appendChild(f);y.appendChild(w);y.appendChild(_);y.appendChild(v);Le.appendChild(y);$();x();G();C();f.addEventListener("click",Ee);window.addEventListener("resize",G);
