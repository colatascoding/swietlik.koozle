(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function r(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(n){if(n.ep)return;n.ep=!0;const o=r(n);fetch(n.href,o)}})();const X=100,I=50;function q(){return{maxHp:X,hp:X,level:1,xp:0,xpToNext:I}}function O(e,t){let r=e.maxHp,a=1;for(const{def:n,count:o}of t)n.hpBonus&&(r+=n.hpBonus*o),n.xpMod&&(a*=Math.pow(n.xpMod,o));return{...e,maxHp:r,xpToNext:Math.floor(I*Math.pow(1.2,e.level-1)/a)}}function K(e,t,r){let a=e.xp+t,n=e.level,o=Math.floor(I*Math.pow(1.2,n-1));for(;a>=o;)a-=o,n++,o=Math.floor(I*Math.pow(1.2,n-1));const s={...e,xp:a,level:n,xpToNext:o,maxHp:e.maxHp+(n-e.level)*10};return O(s,r)}function j(e,t){return{...e,hp:Math.max(0,e.hp-t)}}function Y(e){for(const{def:t}of e)if(t.ruleMod)return t.ruleMod}const D=[3],k=[2,3],L=2;function F(e){if(!e)return{birth:D,survive:k};const t=[],r=[],a=e.toLowerCase().match(/b(\d+)|birth\s*(\d+)/),n=e.toLowerCase().match(/s(\d+)|survive\s*(\d+)/);if(a){const o=a[1]??a[2]??"3";t.push(...o.split("").map(Number))}else t.push(...D);if(n){const o=n[1]??n[2]??"23";r.push(...o.split("").map(Number))}else r.push(...k);return{birth:t,survive:r}}function J(e,t,r){var s;const a=e.length,n=((s=e[0])==null?void 0:s.length)??0;let o=0;for(let i=-1;i<=1;i++)for(let d=-1;d<=1;d++){if(i===0&&d===0)continue;const c=t+i,l=r+d;c<0||c>=a||l<0||l>=n||e[c][l]===1&&(o+=1)}return o}function Q(e,t,r,a){var i,d;const n=t.length,o=((i=t[0])==null?void 0:i.length)??0,s=[];for(let c=-1;c<=1;c++)for(let l=-1;l<=1;l++){if(c===0&&l===0)continue;const h=r+c,f=a+l;if(!(h<0||h>=n||f<0||f>=o)&&t[h][f]===1){const u=((d=e[h])==null?void 0:d[f])??-1;u>=0&&s.push(u)}}return s}function Z(e,t,r,a){var c,l,h;const n=e.length,o=((c=e[0])==null?void 0:c.length)??0,s=e.map(f=>[...f]),i=t.map(f=>[...f]),d=F(a);for(let f=0;f<n;f++)for(let u=0;u<o;u++){if(e[f][u]===L){s[f][u]=L,i[f][u]=-1;continue}const p=J(e,f,u),b=e[f][u]===1,C=((l=t[f])==null?void 0:l[u])??-1,S=C>=0?F((h=r[C])==null?void 0:h.ruleMod):d;if(b){const x=S.survive.includes(p);s[f][u]=x?1:0,i[f][u]=x?C:-1}else{const x=d.birth.includes(p);if(s[f][u]=x?1:0,x){const _=Q(t,e,f,u);i[f][u]=_.length>0?_[Math.floor(Math.random()*_.length)]:-1,i[f][u]<0&&(i[f][u]=0)}else i[f][u]=-1}}return{grid:s,mobGrid:i}}function ee(e,t){return Array.from({length:e},()=>Array.from({length:t},()=>0))}function te(e,t,r=.25){const a=ee(e,t);for(let n=0;n<e;n++)for(let o=0;o<t;o++){const s=n===0||n===e-1||o===0||o===t-1;a[n][o]=s?L:Math.random()<r?1:0}return a}function ne(e,t,r){var n,o;if(((n=e[t])==null?void 0:n[r])===L)return e;const a=e.map(s=>[...s]);return((o=a[t])==null?void 0:o[r])!==void 0&&(a[t][r]=1-a[t][r]),a}function oe(e,t){var n,o;const r=e.length,a=((n=e[0])==null?void 0:n.length)??0;if(t.length!==r||(((o=t[0])==null?void 0:o.length)??0)!==a)return!1;for(let s=0;s<r;s++)for(let i=0;i<a;i++)if(e[s][i]!==t[s][i])return!1;return!0}const $=[{id:"slime",name:"Slime",color:"#7ee8a8",damage:2,xpReward:5,ruleMod:"B3/S23"},{id:"phantom",name:"Phantom",color:"#8ea4e8",damage:4,xpReward:10,ruleMod:"B2/S"},{id:"blob",name:"Blob",color:"#c87ee8",damage:3,xpReward:7,ruleMod:"B34/S34"},{id:"spore",name:"Spore",color:"#e8d87e",damage:1,xpReward:4,ruleMod:"B36/S23"},{id:"glider",name:"Glider",color:"#7ee8e8",damage:3,xpReward:8,ruleMod:"B3/S23"},{id:"pulsar",name:"Pulsar",color:"#e89a7e",damage:6,xpReward:15,ruleMod:"B3/S234"},{id:"shifter",name:"Shifter",color:"#e87ec8",damage:5,xpReward:12,ruleMod:"B23/S36"},{id:"eater",name:"Eater",color:"#5a9a6e",damage:5,xpReward:11,ruleMod:"B3/S23"},{id:"loaf",name:"Loaf",color:"#a88a5a",damage:2,xpReward:6,ruleMod:"B3/S23"},{id:"beehive",name:"Beehive",color:"#e8c87e",damage:4,xpReward:9,ruleMod:"B3/S234"},{id:"toad",name:"Toad",color:"#7eb8e8",damage:4,xpReward:10,ruleMod:"B3/S23"},{id:"pentomino",name:"Pentomino",color:"#e87e7e",damage:7,xpReward:18,ruleMod:"B3/S23"}],re=6;function U(){return Math.floor(Math.random()*re)}function ae(e,t,r){var s,i;const a=e.length,n=((s=e[0])==null?void 0:s.length)??0,o=[];for(let d=0;d<a;d++)for(let c=0;c<n;c++){if(e[d][c]!==1)continue;const l=((i=t[d])==null?void 0:i[c])??0,h=r[l];h&&o.push(h)}return o}const se=12,ie=12,ce=1,le=3;function de(e,t){return e+Math.floor(Math.random()*(t-e+1))}function ue(e){var n;const t=e.length,r=((n=e[0])==null?void 0:n.length)??0,a=Array.from({length:t},()=>Array(r).fill(-1));for(let o=0;o<t;o++)for(let s=0;s<r;s++)e[o][s]===1&&(a[o][s]=U());return a}function W(e,t){const r=te(se,ie);return{id:e,grid:r,mobGrid:ue(r),phase:"edit",stepCount:0,ruleMod:t,changesLeft:de(ce,le)}}function fe(e,t,r){var o;if(e.phase!=="edit"||e.changesLeft<1||((o=e.grid[t])==null?void 0:o[r])===L)return e;const a=ne(e.grid,t,r),n=e.mobGrid.map(s=>[...s]);return a[t][r]===1?n[t][r]=U():n[t][r]=-1,{...e,grid:a,mobGrid:n,changesLeft:e.changesLeft-1}}function me(e){return e.phase!=="edit"?e:{...e,phase:"alive",stepCount:0}}function he(e){if(e.phase!=="alive")return e;const{grid:t,mobGrid:r}=Z(e.grid,e.mobGrid,$,e.ruleMod),a=oe(e.grid,t);return{...e,grid:t,mobGrid:r,stepCount:e.stepCount+1,stable:a}}function pe(e){return{...e,phase:"complete"}}function P(e){var t;return{rows:e.grid.length,cols:((t=e.grid[0])==null?void 0:t.length)??0}}const A=[{id:"lens",name:"Lens of Order",description:"Life follows B3/S23 (classic).",ruleMod:"B3/S23"},{id:"chaos_seed",name:"Chaos Seed",description:"Birth on 2 or 3 neighbors — more growth.",ruleMod:"B23/S36"},{id:"heart_amulet",name:"Heart Amulet",description:"+20 max HP.",hpBonus:20},{id:"xp_gem",name:"Scholar Gem",description:"1.25× XP gain.",xpMod:1.25},{id:"still_life",name:"Still Life",description:"Survive on 2,3,4 — more stable patterns.",ruleMod:"B3/S234"}];function ge(e){return A.find(t=>t.id===e)}function ve(e){const t=A.filter(r=>!e.includes(r.id));return t[Math.floor(Math.random()*t.length)]??A[0]}function be(){const e=[],t=Y(e);return{phase:"playing",rooms:[W("0",t)],currentRoomIndex:0,character:q(),inventory:e}}function M(e){if(e.rooms.length===0)throw new Error("No rooms in state");return e.rooms[e.currentRoomIndex]??e.rooms[0]}function Me(e){const t=Y(e.inventory),r=[...e.rooms,W(String(e.rooms.length),t)];return{...e,rooms:r,currentRoomIndex:r.length-1}}function xe(e,t,r=1){if(r<1)return e;const a=ge(t);if(!a)return e;const n=[...e.inventory],o=n.findIndex(s=>s.def.id===t);return o>=0?n[o]={...n[o],count:n[o].count+r}:n.push({def:a,count:r}),{...e,inventory:n}}function we(e){const t=e.inventory.map(a=>a.def.id),r=ve(t);return xe(e,r.id,1)}function Ce(e,t,r,a){const n=ae(a.grid,a.mobGrid,$),o=n.reduce((d,c)=>d+c.damage,0),s=n.reduce((d,c)=>d+c.xpReward,0);let i={...e,character:j(e.character,o),lastEncounter:{mobs:n,damage:o,xp:s}};return i.phase=i.character.hp<=0?"dead":e.phase,i.character=K(i.character,t+s,i.inventory),i.character=O(i.character,i.inventory),Math.random()<.4&&(i=we(i)),i}const Le="#0d0f14",Ee="#3d4556",Re="#1e232e",ye="rgba(126, 232, 168, 0.15)";function Se(e,t,r,a,n,o,s,i){var l,h,f;const d=t.length,c=((l=t[0])==null?void 0:l.length)??0;e.fillStyle=Le,e.fillRect(0,0,c*o,d*s);for(let u=0;u<d;u++)for(let p=0;p<c;p++){const b=p*o,C=u*s,S=t[u][p];if(S===L)e.fillStyle=Ee,e.fillRect(b,C,o,s);else if(S===1){const x=((h=r[u])==null?void 0:h[p])??0;e.fillStyle=((f=a[x])==null?void 0:f.color)??"#7ee8a8",e.fillRect(b+.5,C+.5,o-1,s-1)}}if(i){e.strokeStyle=Re,e.lineWidth=1;for(let u=0;u<=d;u++)e.beginPath(),e.moveTo(0,u*s),e.lineTo(c*o,u*s),e.stroke();for(let u=0;u<=c;u++)e.beginPath(),e.moveTo(u*o,0),e.lineTo(u*o,d*s),e.stroke()}n==="edit"&&(e.fillStyle=ye,e.fillRect(0,0,c*o,d*s))}function Be(e,t,r,a=20){const n=e.width,o=e.height,s=Math.max(1,r),i=Math.max(1,t),d=Math.max(1,Math.min(a,Math.floor(n/s),Math.floor(o/i))),c=d,l=r*d,h=t*c;return{cellW:d,cellH:c,offsetX:(n-l)/2,offsetY:(o-h)/2}}function Ie(e,t,r,a,n,o,s,i,d){if(r<=0||a<=0)return null;const c=d.getBoundingClientRect();if(!c.width||!c.height)return null;const l=d.width/c.width,h=d.height/c.height,f=(s-c.left)*l-e,u=(i-c.top)*h-t,p=Math.floor(f/r),b=Math.floor(u/a);return b>=0&&b<n&&p>=0&&p<o?{row:b,col:p}:null}let m=be(),v={cellW:12,cellH:12,offsetX:0,offsetY:0},B=null;const Ne=120,Te=document.getElementById("app"),g=document.createElement("canvas");g.id="roomCanvas";const N=document.createElement("header");N.className="header";const w=document.createElement("aside");w.className="sidebar";function z(){N.innerHTML="";const e=document.createElement("h1");e.textContent="Świetlik Koozle";const t=document.createElement("span");t.className="muted",t.textContent=`Room ${m.currentRoomIndex+1} / ${m.rooms.length}`,t.style.color="var(--muted)",N.append(e,t)}function T(){const e=M(m);P(e),w.innerHTML="";const t=document.createElement("div");t.className="panel";const r=document.createElement("div");r.className=`room-status ${e.phase}${e.stable?" stable":""}`,r.textContent=e.phase==="edit"?`Changes left: ${e.changesLeft}. Toggle cells, then start life.`:e.phase==="alive"?e.stable?`Life stable — no change (step ${e.stepCount}). Finish to collect reward.`:`Life running — step ${e.stepCount}`:"Room complete — go to next",t.appendChild(r);const a=document.createElement("div");a.style.marginTop="0.75rem";const n=document.createElement("button");n.className="btn btn-block",n.textContent=e.phase==="edit"?"Start life":e.phase==="alive"?"Running…":"Next room",n.disabled=e.phase==="alive",n.onclick=()=>{const l=M(m);l.phase==="edit"?(R(me(l)),Ge()):l.phase==="complete"&&(m=Ce(m,15+l.stepCount,!0,l),m=Me(m),R(M(m)),G(),z(),T(),E())};const o=document.createElement("button");if(o.className="btn btn-block",o.textContent="Finish room & get reward",o.style.marginTop="0.5rem",o.disabled=e.phase!=="alive",o.onclick=()=>{const l=M(m);l.phase==="alive"&&(G(),R(pe(l)),T(),E())},a.append(n,o),t.append(a),w.appendChild(t),m.lastEncounter&&m.lastEncounter.mobs.length>0){const l=document.createElement("div");l.className="panel encounter-panel";const h=m.lastEncounter.mobs.map(f=>f.name).join(", ");l.innerHTML=`
      <h3>Last encounter</h3>
      <p class="encounter-text">Defeated: ${h}</p>
      <p class="encounter-text">+${m.lastEncounter.xp} XP · Took ${m.lastEncounter.damage} damage</p>
    `,w.appendChild(l)}const s=document.createElement("div");s.className="panel";const i=O(m.character,m.inventory);s.innerHTML=`
    <h3>Character</h3>
    <div class="stat-row"><span>Level</span><span>${i.level}</span></div>
    <div class="stat-row"><span>XP</span><span>${i.xp} / ${i.xpToNext}</span></div>
    <div class="stat-row"><span>HP</span><span>${m.character.hp} / ${i.maxHp}</span></div>
    <div class="health-bar"><div class="health-fill" style="width: ${i.maxHp>0?100*m.character.hp/i.maxHp:0}%"></div></div>
  `,w.appendChild(s);const d=document.createElement("div");d.className="panel",d.innerHTML="<h3>Inventory</h3>";const c=document.createElement("ul");if(c.className="inventory-list",m.inventory.length===0){const l=document.createElement("li");l.textContent="No items yet. Complete rooms for rewards.",l.style.color="var(--muted)",c.appendChild(l)}else for(const{def:l,count:h}of m.inventory){const f=document.createElement("li");f.textContent=`${l.name}${h>1?` ×${h}`:""}`,f.title=l.description,c.appendChild(f)}d.appendChild(c),w.appendChild(d)}function R(e){const t=[...m.rooms];t[m.currentRoomIndex]=e,m={...m,rooms:t}}function Ge(){G(),B=window.setInterval(()=>{const e=M(m);if(e.phase!=="alive")return;const t=he(e);R(t),T(),E(),t.stable&&G()},Ne)}function G(){B!=null&&(clearInterval(B),B=null)}function E(){const e=M(m);P(e);const t=g.getContext("2d");t.save(),t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,g.width,g.height),t.restore(),t.save(),t.translate(v.offsetX,v.offsetY),Se(t,e.grid,e.mobGrid,$,e.phase,v.cellW,v.cellH,e.phase==="edit"||v.cellW>=14),t.restore()}function V(){const t=g.parentElement.getBoundingClientRect(),r=M(m),{rows:a,cols:n}=P(r);g.width=t.width,g.height=t.height,v=Be(g,a,n,22),E()}function Pe(e){const t=M(m);if(t.phase!=="edit"||t.changesLeft<1)return;const{rows:r,cols:a}=P(t),n=Ie(v.offsetX,v.offsetY,v.cellW,v.cellH,r,a,e.clientX,e.clientY,g);n&&(R(fe(t,n.row,n.col)),E())}const y=document.createElement("div");y.className="game-layout";const H=document.createElement("div");H.className="room-canvas-wrap";H.appendChild(g);y.appendChild(N);y.appendChild(H);y.appendChild(w);Te.appendChild(y);z();T();V();E();g.addEventListener("click",Pe);window.addEventListener("resize",V);
