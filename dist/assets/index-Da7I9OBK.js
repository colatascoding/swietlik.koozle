(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function s(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(n){if(n.ep)return;n.ep=!0;const r=s(n);fetch(n.href,r)}})();const B=100,E=50;function X(){return{maxHp:B,hp:B,level:1,xp:0,xpToNext:E}}function T(e,t){let s=e.maxHp,o=1;for(const{def:n,count:r}of t)n.hpBonus&&(s+=n.hpBonus*r),n.xpMod&&(o*=Math.pow(n.xpMod,r));return{...e,maxHp:s,xpToNext:Math.floor(E*Math.pow(1.2,e.level-1)/o)}}function k(e,t,s){let o=e.xp+t,n=e.level,r=Math.floor(E*Math.pow(1.2,n-1));for(;o>=r;)o-=r,n++,r=Math.floor(E*Math.pow(1.2,n-1));const a={...e,xp:o,level:n,xpToNext:r,maxHp:e.maxHp+(n-e.level)*10};return T(a,s)}function P(e){for(const{def:t}of e)if(t.ruleMod)return t.ruleMod}const O=[3],H=[2,3];function Y(e){if(!e)return{birth:O,survive:H};const t=[],s=[],o=e.toLowerCase().match(/b(\d+)|birth\s*(\d+)/),n=e.toLowerCase().match(/s(\d+)|survive\s*(\d+)/);if(o){const r=o[1]??o[2]??"3";t.push(...r.split("").map(Number))}else t.push(...O);if(n){const r=n[1]??n[2]??"23";s.push(...r.split("").map(Number))}else s.push(...H);return{birth:t,survive:s}}function F(e,t,s){var a;const o=e.length,n=((a=e[0])==null?void 0:a.length)??0;let r=0;for(let d=-1;d<=1;d++)for(let c=-1;c<=1;c++){if(d===0&&c===0)continue;const i=(t+d+o)%o,l=(s+c+n)%n;r+=e[i][l]}return r}function U(e,t){var d;const{birth:s,survive:o}=Y(t),n=e.length,r=((d=e[0])==null?void 0:d.length)??0,a=e.map(c=>[...c]);for(let c=0;c<n;c++)for(let i=0;i<r;i++){const l=F(e,c,i);e[c][i]===1?a[c][i]=o.includes(l)?1:0:a[c][i]=s.includes(l)?1:0}return a}function V(e,t){return Array.from({length:e},()=>Array.from({length:t},()=>0))}function z(e,t,s){var n;const o=e.map(r=>[...r]);return((n=o[t])==null?void 0:n[s])!==void 0&&(o[t][s]=1-o[t][s]),o}const W=12,K=12;function A(e,t){return{id:e,grid:V(W,K),phase:"edit",stepCount:0,ruleMod:t}}function q(e,t,s){return e.phase!=="edit"?e:{...e,grid:z(e.grid,t,s)}}function j(e){return e.phase!=="edit"?e:{...e,phase:"alive",stepCount:0}}function J(e){return e.phase!=="alive"?e:{...e,grid:U(e.grid,e.ruleMod),stepCount:e.stepCount+1}}function Q(e){return{...e,phase:"complete"}}function b(e){var t;return{rows:e.grid.length,cols:((t=e.grid[0])==null?void 0:t.length)??0}}const S=[{id:"lens",name:"Lens of Order",description:"Life follows B3/S23 (classic).",ruleMod:"B3/S23"},{id:"chaos_seed",name:"Chaos Seed",description:"Birth on 2 or 3 neighbors — more growth.",ruleMod:"B23/S36"},{id:"heart_amulet",name:"Heart Amulet",description:"+20 max HP.",hpBonus:20},{id:"xp_gem",name:"Scholar Gem",description:"1.25× XP gain.",xpMod:1.25},{id:"still_life",name:"Still Life",description:"Survive on 2,3,4 — more stable patterns.",ruleMod:"B3/S234"}];function Z(e){return S.find(t=>t.id===e)}function ee(e){const t=S.filter(s=>!e.includes(s.id));return t[Math.floor(Math.random()*t.length)]??S[0]}function te(){const e=[],t=P(e);return{phase:"playing",rooms:[A("0",t)],currentRoomIndex:0,character:X(),inventory:e}}function m(e){if(e.rooms.length===0)throw new Error("No rooms in state");return e.rooms[e.currentRoomIndex]??e.rooms[0]}function ne(e){const t=P(e.inventory),s=[...e.rooms,A(String(e.rooms.length),t)];return{...e,rooms:s,currentRoomIndex:s.length-1}}function oe(e,t,s=1){if(s<1)return e;const o=Z(t);if(!o)return e;const n=[...e.inventory],r=n.findIndex(a=>a.def.id===t);return r>=0?n[r]={...n[r],count:n[r].count+s}:n.push({def:o,count:s}),{...e,inventory:n}}function re(e){const t=e.inventory.map(o=>o.def.id),s=ee(t);return oe(e,s.id,1)}function se(e,t,s){let o={...e,character:k(e.character,t,e.inventory)};return o.character=T(o.character,o.inventory),Math.random()<.4&&(o=re(o)),o}const ie="#7ee8a8",ce="#0d0f14",ae="#1e232e",le="rgba(126, 232, 168, 0.15)";function de(e,t,s,o,n,r){var c;const a=t.length,d=((c=t[0])==null?void 0:c.length)??0;e.fillStyle=ce,e.fillRect(0,0,d*o,a*n);for(let i=0;i<a;i++)for(let l=0;l<d;l++){const h=l*o,v=i*n;t[i][l]===1&&(e.fillStyle=ie,e.fillRect(h+.5,v+.5,o-1,n-1))}if(r){e.strokeStyle=ae,e.lineWidth=1;for(let i=0;i<=a;i++)e.beginPath(),e.moveTo(0,i*n),e.lineTo(d*o,i*n),e.stroke();for(let i=0;i<=d;i++)e.beginPath(),e.moveTo(i*o,0),e.lineTo(i*o,a*n),e.stroke()}s==="edit"&&(e.fillStyle=le,e.fillRect(0,0,d*o,a*n))}function ue(e,t,s,o=20){const n=e.width,r=e.height,a=Math.max(1,s),d=Math.max(1,t),c=Math.max(1,Math.min(o,Math.floor(n/a),Math.floor(r/d))),i=c,l=s*c,h=t*i;return{cellW:c,cellH:i,offsetX:(n-l)/2,offsetY:(r-h)/2}}function pe(e,t,s,o,n,r,a,d,c){if(s<=0||o<=0)return null;const i=c.getBoundingClientRect();if(!i.width||!i.height)return null;const l=c.width/i.width,h=c.height/i.height,v=(a-i.left)*l-e,G=(d-i.top)*h-t,R=Math.floor(v/s),I=Math.floor(G/o);return I>=0&&I<n&&R>=0&&R<r?{row:I,col:R}:null}let u=te(),f={cellW:12,cellH:12,offsetX:0,offsetY:0},x=null;const fe=120,he=document.getElementById("app"),p=document.createElement("canvas");p.id="roomCanvas";const L=document.createElement("header");L.className="header";const g=document.createElement("aside");g.className="sidebar";function $(){L.innerHTML="";const e=document.createElement("h1");e.textContent="Świetlik Koozle";const t=document.createElement("span");t.className="muted",t.textContent=`Room ${u.currentRoomIndex+1} / ${u.rooms.length}`,t.style.color="var(--muted)",L.append(e,t)}function M(){const e=m(u);b(e),g.innerHTML="";const t=document.createElement("div");t.className="panel";const s=document.createElement("div");s.className=`room-status ${e.phase}`,s.textContent=e.phase==="edit"?"Draw on the grid, then start life":e.phase==="alive"?`Life running — step ${e.stepCount}`:"Room complete — go to next",t.appendChild(s);const o=document.createElement("div");o.style.marginTop="0.75rem";const n=document.createElement("button");n.className="btn btn-block",n.textContent=e.phase==="edit"?"Start life":e.phase==="alive"?"Running…":"Next room",n.disabled=e.phase==="alive",n.onclick=()=>{const l=m(u);l.phase==="edit"?(y(j(l)),me()):l.phase==="complete"&&(u=se(u,15+l.stepCount),u=ne(u),y(m(u)),N(),$(),M(),C())};const r=document.createElement("button");r.className="btn btn-block",r.textContent="Finish room & get reward",r.style.marginTop="0.5rem",r.disabled=e.phase!=="alive",r.onclick=()=>{const l=m(u);l.phase==="alive"&&(N(),y(Q(l)),M(),C())},o.append(n,r),t.append(o),g.appendChild(t);const a=document.createElement("div");a.className="panel";const d=T(u.character,u.inventory);a.innerHTML=`
    <h3>Character</h3>
    <div class="stat-row"><span>Level</span><span>${d.level}</span></div>
    <div class="stat-row"><span>XP</span><span>${d.xp} / ${d.xpToNext}</span></div>
    <div class="stat-row"><span>HP</span><span>${u.character.hp} / ${d.maxHp}</span></div>
    <div class="health-bar"><div class="health-fill" style="width: ${d.maxHp>0?100*u.character.hp/d.maxHp:0}%"></div></div>
  `,g.appendChild(a);const c=document.createElement("div");c.className="panel",c.innerHTML="<h3>Inventory</h3>";const i=document.createElement("ul");if(i.className="inventory-list",u.inventory.length===0){const l=document.createElement("li");l.textContent="No items yet. Complete rooms for rewards.",l.style.color="var(--muted)",i.appendChild(l)}else for(const{def:l,count:h}of u.inventory){const v=document.createElement("li");v.textContent=`${l.name}${h>1?` ×${h}`:""}`,v.title=l.description,i.appendChild(v)}c.appendChild(i),g.appendChild(c)}function y(e){const t=[...u.rooms];t[u.currentRoomIndex]=e,u={...u,rooms:t}}function me(){N(),x=window.setInterval(()=>{const e=m(u);e.phase==="alive"&&(y(J(e)),M(),C())},fe)}function N(){x!=null&&(clearInterval(x),x=null)}function C(){const e=m(u);b(e);const t=p.getContext("2d");t.save(),t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,p.width,p.height),t.restore(),t.save(),t.translate(f.offsetX,f.offsetY),de(t,e.grid,e.phase,f.cellW,f.cellH,e.phase==="edit"||f.cellW>=14),t.restore()}function D(){const t=p.parentElement.getBoundingClientRect(),s=m(u),{rows:o,cols:n}=b(s);p.width=t.width,p.height=t.height,f=ue(p,o,n,22),C()}function ve(e){const t=m(u);if(t.phase!=="edit")return;const{rows:s,cols:o}=b(t),n=pe(f.offsetX,f.offsetY,f.cellW,f.cellH,s,o,e.clientX,e.clientY,p);n&&(y(q(t,n.row,n.col)),C())}const w=document.createElement("div");w.className="game-layout";const _=document.createElement("div");_.className="room-canvas-wrap";_.appendChild(p);w.appendChild(L);w.appendChild(_);w.appendChild(g);he.appendChild(w);$();M();D();C();p.addEventListener("click",ve);window.addEventListener("resize",D);
