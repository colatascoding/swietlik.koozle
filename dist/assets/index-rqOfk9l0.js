(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function r(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(n){if(n.ep)return;n.ep=!0;const o=r(n);fetch(n.href,o)}})();const O=100,R=50;function F(){return{maxHp:O,hp:O,level:1,xp:0,xpToNext:R}}function _(e,t){let r=e.maxHp,a=1;for(const{def:n,count:o}of t)n.hpBonus&&(r+=n.hpBonus*o),n.xpMod&&(a*=Math.pow(n.xpMod,o));return{...e,maxHp:r,xpToNext:Math.floor(R*Math.pow(1.2,e.level-1)/a)}}function Y(e,t,r){let a=e.xp+t,n=e.level,o=Math.floor(R*Math.pow(1.2,n-1));for(;a>=o;)a-=o,n++,o=Math.floor(R*Math.pow(1.2,n-1));const i={...e,xp:a,level:n,xpToNext:o,maxHp:e.maxHp+(n-e.level)*10};return _(i,r)}function U(e,t){return{...e,hp:Math.max(0,e.hp-t)}}function G(e){for(const{def:t}of e)if(t.ruleMod)return t.ruleMod}const A=[3],$=[2,3],x=2;function V(e){if(!e)return{birth:A,survive:$};const t=[],r=[],a=e.toLowerCase().match(/b(\d+)|birth\s*(\d+)/),n=e.toLowerCase().match(/s(\d+)|survive\s*(\d+)/);if(a){const o=a[1]??a[2]??"3";t.push(...o.split("").map(Number))}else t.push(...A);if(n){const o=n[1]??n[2]??"23";r.push(...o.split("").map(Number))}else r.push(...$);return{birth:t,survive:r}}function W(e,t,r){var i;const a=e.length,n=((i=e[0])==null?void 0:i.length)??0;let o=0;for(let c=-1;c<=1;c++)for(let l=-1;l<=1;l++){if(c===0&&l===0)continue;const s=t+c,d=r+l;s<0||s>=a||d<0||d>=n||e[s][d]===1&&(o+=1)}return o}function z(e,t){var c;const{birth:r,survive:a}=V(t),n=e.length,o=((c=e[0])==null?void 0:c.length)??0,i=e.map(l=>[...l]);for(let l=0;l<n;l++)for(let s=0;s<o;s++){if(e[l][s]===x){i[l][s]=x;continue}const d=W(e,l,s);e[l][s]===1?i[l][s]=a.includes(d)?1:0:i[l][s]=r.includes(d)?1:0}return i}function q(e,t){return Array.from({length:e},()=>Array.from({length:t},()=>0))}function K(e,t,r=.25){const a=q(e,t);for(let n=0;n<e;n++)for(let o=0;o<t;o++){const i=n===0||n===e-1||o===0||o===t-1;a[n][o]=i?x:Math.random()<r?1:0}return a}function j(e,t,r){var n,o;if(((n=e[t])==null?void 0:n[r])===x)return e;const a=e.map(i=>[...i]);return((o=a[t])==null?void 0:o[r])!==void 0&&(a[t][r]=1-a[t][r]),a}function J(e,t){var n,o;const r=e.length,a=((n=e[0])==null?void 0:n.length)??0;if(t.length!==r||(((o=t[0])==null?void 0:o.length)??0)!==a)return!1;for(let i=0;i<r;i++)for(let c=0;c<a;c++)if(e[i][c]!==t[i][c])return!1;return!0}const Q=12,Z=12,ee=1,te=3;function ne(e,t){return e+Math.floor(Math.random()*(t-e+1))}function X(e,t){return{id:e,grid:K(Q,Z),phase:"edit",stepCount:0,ruleMod:t,changesLeft:ne(ee,te)}}function oe(e,t,r){var a;return e.phase!=="edit"||e.changesLeft<1||((a=e.grid[t])==null?void 0:a[r])===x?e:{...e,grid:j(e.grid,t,r),changesLeft:e.changesLeft-1}}function re(e){return e.phase!=="edit"?e:{...e,phase:"alive",stepCount:0}}function ae(e){if(e.phase!=="alive")return e;const t=z(e.grid,e.ruleMod),r=J(e.grid,t);return{...e,grid:t,stepCount:e.stepCount+1,stable:r}}function se(e){return{...e,phase:"complete"}}function I(e){var t;return{rows:e.grid.length,cols:((t=e.grid[0])==null?void 0:t.length)??0}}const P=[{id:"lens",name:"Lens of Order",description:"Life follows B3/S23 (classic).",ruleMod:"B3/S23"},{id:"chaos_seed",name:"Chaos Seed",description:"Birth on 2 or 3 neighbors — more growth.",ruleMod:"B23/S36"},{id:"heart_amulet",name:"Heart Amulet",description:"+20 max HP.",hpBonus:20},{id:"xp_gem",name:"Scholar Gem",description:"1.25× XP gain.",xpMod:1.25},{id:"still_life",name:"Still Life",description:"Survive on 2,3,4 — more stable patterns.",ruleMod:"B3/S234"}];function ie(e){return P.find(t=>t.id===e)}function ce(e){const t=P.filter(r=>!e.includes(r.id));return t[Math.floor(Math.random()*t.length)]??P[0]}const H=[{id:"slime",name:"Slime",damage:2,xpReward:5},{id:"phantom",name:"Phantom",damage:4,xpReward:10},{id:"blob",name:"Blob",damage:3,xpReward:7},{id:"spore",name:"Spore",damage:1,xpReward:4},{id:"shifter",name:"Shifter",damage:5,xpReward:12},{id:"glider",name:"Glider",damage:3,xpReward:8},{id:"pulsar",name:"Pulsar",damage:6,xpReward:15},{id:"eater",name:"Eater",damage:5,xpReward:11},{id:"loaf",name:"Loaf",damage:2,xpReward:6},{id:"beehive",name:"Beehive",damage:4,xpReward:9},{id:"toad",name:"Toad",damage:4,xpReward:10},{id:"pentomino",name:"Pentomino",damage:7,xpReward:18}];function le(e){const t=[];for(let r=0;r<e;r++)t.push(H[Math.floor(Math.random()*H.length)]);return t}function de(e){const t=Math.min(3,1+Math.floor(e/2)+(Math.random()<.4?1:0));return le(Math.max(1,t))}function ue(){const e=[],t=G(e);return{phase:"playing",rooms:[X("0",t)],currentRoomIndex:0,character:F(),inventory:e}}function g(e){if(e.rooms.length===0)throw new Error("No rooms in state");return e.rooms[e.currentRoomIndex]??e.rooms[0]}function pe(e){const t=G(e.inventory),r=[...e.rooms,X(String(e.rooms.length),t)];return{...e,rooms:r,currentRoomIndex:r.length-1}}function me(e,t,r=1){if(r<1)return e;const a=ie(t);if(!a)return e;const n=[...e.inventory],o=n.findIndex(i=>i.def.id===t);return o>=0?n[o]={...n[o],count:n[o].count+r}:n.push({def:a,count:r}),{...e,inventory:n}}function fe(e){const t=e.inventory.map(a=>a.def.id),r=ce(t);return me(e,r.id,1)}function he(e,t,r,a){const n=de(a),o=n.reduce((l,s)=>l+s.damage,0),i=n.reduce((l,s)=>l+s.xpReward,0);let c={...e,character:U(e.character,o),lastEncounter:{mobs:n,damage:o,xp:i}};return c.phase=c.character.hp<=0?"dead":e.phase,c.character=Y(c.character,t+i,c.inventory),c.character=_(c.character,c.inventory),Math.random()<.4&&(c=fe(c)),c}const ge="#7ee8a8",ve="#0d0f14",xe="#3d4556",Le="#1e232e",Ce="rgba(126, 232, 168, 0.15)";function Me(e,t,r,a,n,o){var l;const i=t.length,c=((l=t[0])==null?void 0:l.length)??0;e.fillStyle=ve,e.fillRect(0,0,c*a,i*n);for(let s=0;s<i;s++)for(let d=0;d<c;d++){const p=d*a,f=s*n,E=t[s][d];E===x?(e.fillStyle=xe,e.fillRect(p,f,a,n)):E===1&&(e.fillStyle=ge,e.fillRect(p+.5,f+.5,a-1,n-1))}if(o){e.strokeStyle=Le,e.lineWidth=1;for(let s=0;s<=i;s++)e.beginPath(),e.moveTo(0,s*n),e.lineTo(c*a,s*n),e.stroke();for(let s=0;s<=c;s++)e.beginPath(),e.moveTo(s*a,0),e.lineTo(s*a,i*n),e.stroke()}r==="edit"&&(e.fillStyle=Ce,e.fillRect(0,0,c*a,i*n))}function Ee(e,t,r,a=20){const n=e.width,o=e.height,i=Math.max(1,r),c=Math.max(1,t),l=Math.max(1,Math.min(a,Math.floor(n/i),Math.floor(o/c))),s=l,d=r*l,p=t*s;return{cellW:l,cellH:s,offsetX:(n-d)/2,offsetY:(o-p)/2}}function we(e,t,r,a,n,o,i,c,l){if(r<=0||a<=0)return null;const s=l.getBoundingClientRect();if(!s.width||!s.height)return null;const d=l.width/s.width,p=l.height/s.height,f=(i-s.left)*d-e,E=(c-s.top)*p-t,N=Math.floor(f/r),T=Math.floor(E/a);return T>=0&&T<n&&N>=0&&N<o?{row:T,col:N}:null}let u=ue(),h={cellW:12,cellH:12,offsetX:0,offsetY:0},w=null;const Re=120,be=document.getElementById("app"),m=document.createElement("canvas");m.id="roomCanvas";const b=document.createElement("header");b.className="header";const v=document.createElement("aside");v.className="sidebar";function D(){b.innerHTML="";const e=document.createElement("h1");e.textContent="Świetlik Koozle";const t=document.createElement("span");t.className="muted",t.textContent=`Room ${u.currentRoomIndex+1} / ${u.rooms.length}`,t.style.color="var(--muted)",b.append(e,t)}function y(){const e=g(u);I(e),v.innerHTML="";const t=document.createElement("div");t.className="panel";const r=document.createElement("div");r.className=`room-status ${e.phase}${e.stable?" stable":""}`,r.textContent=e.phase==="edit"?`Changes left: ${e.changesLeft}. Toggle cells, then start life.`:e.phase==="alive"?e.stable?`Life stable — no change (step ${e.stepCount}). Finish to collect reward.`:`Life running — step ${e.stepCount}`:"Room complete — go to next",t.appendChild(r);const a=document.createElement("div");a.style.marginTop="0.75rem";const n=document.createElement("button");n.className="btn btn-block",n.textContent=e.phase==="edit"?"Start life":e.phase==="alive"?"Running…":"Next room",n.disabled=e.phase==="alive",n.onclick=()=>{const d=g(u);d.phase==="edit"?(C(re(d)),ye()):d.phase==="complete"&&(u=he(u,15+d.stepCount,!0,u.currentRoomIndex),u=pe(u),C(g(u)),S(),D(),y(),L())};const o=document.createElement("button");if(o.className="btn btn-block",o.textContent="Finish room & get reward",o.style.marginTop="0.5rem",o.disabled=e.phase!=="alive",o.onclick=()=>{const d=g(u);d.phase==="alive"&&(S(),C(se(d)),y(),L())},a.append(n,o),t.append(a),v.appendChild(t),u.lastEncounter&&u.lastEncounter.mobs.length>0){const d=document.createElement("div");d.className="panel encounter-panel";const p=u.lastEncounter.mobs.map(f=>f.name).join(", ");d.innerHTML=`
      <h3>Last encounter</h3>
      <p class="encounter-text">Defeated: ${p}</p>
      <p class="encounter-text">+${u.lastEncounter.xp} XP · Took ${u.lastEncounter.damage} damage</p>
    `,v.appendChild(d)}const i=document.createElement("div");i.className="panel";const c=_(u.character,u.inventory);i.innerHTML=`
    <h3>Character</h3>
    <div class="stat-row"><span>Level</span><span>${c.level}</span></div>
    <div class="stat-row"><span>XP</span><span>${c.xp} / ${c.xpToNext}</span></div>
    <div class="stat-row"><span>HP</span><span>${u.character.hp} / ${c.maxHp}</span></div>
    <div class="health-bar"><div class="health-fill" style="width: ${c.maxHp>0?100*u.character.hp/c.maxHp:0}%"></div></div>
  `,v.appendChild(i);const l=document.createElement("div");l.className="panel",l.innerHTML="<h3>Inventory</h3>";const s=document.createElement("ul");if(s.className="inventory-list",u.inventory.length===0){const d=document.createElement("li");d.textContent="No items yet. Complete rooms for rewards.",d.style.color="var(--muted)",s.appendChild(d)}else for(const{def:d,count:p}of u.inventory){const f=document.createElement("li");f.textContent=`${d.name}${p>1?` ×${p}`:""}`,f.title=d.description,s.appendChild(f)}l.appendChild(s),v.appendChild(l)}function C(e){const t=[...u.rooms];t[u.currentRoomIndex]=e,u={...u,rooms:t}}function ye(){S(),w=window.setInterval(()=>{const e=g(u);if(e.phase!=="alive")return;const t=ae(e);C(t),y(),L(),t.stable&&S()},Re)}function S(){w!=null&&(clearInterval(w),w=null)}function L(){const e=g(u);I(e);const t=m.getContext("2d");t.save(),t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,m.width,m.height),t.restore(),t.save(),t.translate(h.offsetX,h.offsetY),Me(t,e.grid,e.phase,h.cellW,h.cellH,e.phase==="edit"||h.cellW>=14),t.restore()}function k(){const t=m.parentElement.getBoundingClientRect(),r=g(u),{rows:a,cols:n}=I(r);m.width=t.width,m.height=t.height,h=Ee(m,a,n,22),L()}function Se(e){const t=g(u);if(t.phase!=="edit"||t.changesLeft<1)return;const{rows:r,cols:a}=I(t),n=we(h.offsetX,h.offsetY,h.cellW,h.cellH,r,a,e.clientX,e.clientY,m);n&&(C(oe(t,n.row,n.col)),L())}const M=document.createElement("div");M.className="game-layout";const B=document.createElement("div");B.className="room-canvas-wrap";B.appendChild(m);M.appendChild(b);M.appendChild(B);M.appendChild(v);be.appendChild(M);D();y();k();L();m.addEventListener("click",Se);window.addEventListener("resize",k);
